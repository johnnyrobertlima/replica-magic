
import { useState } from "react";
import { useToast } from "@/components/ui/use-toast";
import { sendOutlookEmail } from "../utils/outlookEmailUtils";
import { ClientDebtSummary, FinancialTitle } from "@/hooks/bluebay/types/financialTypes";
import { formatCurrency } from "@/utils/formatters";
import { format } from "date-fns";
import { ptBR } from "date-fns/locale";

export const useCollectionMessage = (
  selectedClient: ClientDebtSummary | null,
  clientTitles: FinancialTitle[],
  onCollectionConfirm: () => void
) => {
  const { toast } = useToast();
  const [isSending, setIsSending] = useState(false);

  const createMessageContent = () => {
    if (!selectedClient) return "";
    
    let titlesText = "";
    clientTitles.forEach(title => {
      const formattedDate = title.DTVENCIMENTO ? format(new Date(title.DTVENCIMENTO), 'dd/MM/yyyy', { locale: ptBR }) : 'N/A';
      
      titlesText += `\nN¬∫ do T√≠tulo: ${title.NUMDOCUMENTO || title.NUMNOTA}
Valor: ${formatCurrency(title.VLRSALDO)}
Vencimento: ${formattedDate}\n`;
    });
    
    // Calcular os totais para incluir na mensagem
    const totalTitulos = clientTitles.length;
    const valorTotalTitulos = clientTitles.reduce((total, title) => total + title.VLRSALDO, 0);

    const totalInfo = `\nTotal de T√≠tulos Vencidos: ${totalTitulos}
Valor Total dos T√≠tulos: ${formatCurrency(valorTotalTitulos)}\n`;
    
    const messageText = `Assunto: T√≠tulos em atraso - Bluebay

Ol√°,

Verificamos que a empresa ${selectedClient.CLIENTE_NOME} possui t√≠tulo(s) com vencimento em aberto junto √† Bluebay.

Pedimos a gentileza de acessar nosso portal para realizar o download dos boletos e efetuar o pagamento o quanto antes, evitando assim encargos adicionais ou restri√ß√µes comerciais.

Segue abaixo o(s) t√≠tulo(s) vencido(s):
${titlesText}
${totalInfo}
Acesse seu portal atrav√©s do link abaixo:
üîó Acessar Portal Bluebay

Em caso de d√∫vidas, nossa equipe est√° √† disposi√ß√£o para ajud√°-lo.

Atenciosamente,
Equipe Financeira ‚Äì Bluebay Importadora
üìß financeiro@bluebay.com.br
üìû (11) 1234-5678`;

    return messageText;
  };

  const handleCopyText = () => {
    const messageText = createMessageContent();
    
    navigator.clipboard.writeText(messageText).then(() => {
      toast({
        title: "Copiado!",
        description: "Texto copiado para a √°rea de transfer√™ncia",
      });
    }).catch(err => {
      console.error('Erro ao copiar: ', err);
      toast({
        variant: "destructive",
        title: "Erro",
        description: "N√£o foi poss√≠vel copiar o texto",
      });
    });
  };

  const handleSendOutlookEmail = async () => {
    if (!selectedClient) return;
    
    setIsSending(true);
    
    try {
      // Prepare message with linebreaks suitable for email
      const emailBody = createMessageContent().replace(/\n/g, '\n');
      
      toast({
        title: "Abrindo cliente de e-mail",
        description: "Se o cliente de e-mail n√£o abrir, voc√™ pode usar a op√ß√£o 'Copiar Texto'",
      });
      
      // Log para debug
      console.log("Tentando enviar e-mail para:", selectedClient.CLIENTE_NOME);
      
      await sendOutlookEmail({
        subject: `T√≠tulos em atraso - Bluebay - ${selectedClient.CLIENTE_NOME}`,
        body: emailBody,
        clientName: selectedClient.CLIENTE_NOME
      });
      
      // Registramos a cobran√ßa como feita ap√≥s algum tempo
      // para dar tempo do usu√°rio interagir com o cliente de email
      setTimeout(() => {
        onCollectionConfirm();
        
        toast({
          title: "Cobran√ßa registrada",
          description: `A cobran√ßa para ${selectedClient.CLIENTE_NOME} foi registrada com sucesso.`,
        });
      }, 1000);
      
    } catch (error) {
      console.error('Erro ao enviar e-mail:', error);
      toast({
        variant: "destructive",
        title: "Erro",
        description: "N√£o foi poss√≠vel abrir o cliente de e-mail. Por favor, use a op√ß√£o 'Copiar Texto'.",
      });
    } finally {
      setIsSending(false);
    }
  };

  return {
    isSending,
    createMessageContent,
    handleCopyText,
    handleSendOutlookEmail
  };
};
